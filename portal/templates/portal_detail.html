{% extends 'base.html' %}

{% load static %}

{% block title %}
    <title>{{portal}}</title>
    <style>
        .widget {
            position: absolute;
            user-select: none;
        }
    </style>
{% endblock title %}

{% block content %}
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'add-widget' %}" enctype="multipart/form-data" id="widgetAddForm">
                    {% csrf_token %}
                    {{ widgetForm.as_p }}
                    <button class="btn btn-primary" type="submit" id="saveWidgetButton">Save</button>
                </form>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        var select = document.getElementById('widgetType');
                        select.selectedIndex = 0;
                    });
                
                    document.getElementById('widgetType').addEventListener("change", function () {
                        var type = this.value;
                        var contentField = document.getElementById('content');
                        var imageField = document.getElementById('image');
                        
                        if (type === 'text') {
                            contentField.style.display = "block";
                        } else {
                            contentField.style.display = "none";
                        }
                        
                        if (type === "image") {
                            imageField.style.display = "block";
                        } else {
                            imageField.style.display = "none";
                        }
                        
                    });
                </script>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <select class="form-control" id="widgetChoice">
                    {% for widget in widgets %}
                        <option value="{{widget.id}}">
                            {{widget}} {% if widget.widget_type == "text" %}({{widget.content}}){% else %}({{widget.image.name}}){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <label for="width">Width:</label>
                <input class="form-control" type="number" id="width" min="10" max="600">
                <label for="height">Height:</label>
                <input class="form-control" type="number" id="height" min="10" max="600">
                <label for="z-index">Z-index:</label>
                <input class="form-control" type="number" id="z-index" min="0">
                <button class="btn btn-primary" type="submit" id="editSaveButton">Save</button>
                <form method="post" action="" id="deleteWidgetForm">
                    {% csrf_token %}
                    <button class="btn btn-danger" id="deleteWidgetButton" type="submit">Delete</button>
                </form>
                <script>
                    document.getElementById("deleteWidgetButton").addEventListener("click", function () {
                        var select = document.getElementById('widgetChoice');
                        var widget_id = select.options[select.selectedIndex].value;
                        var form = document.getElementById('deleteWidgetForm');
                        form.action = `/widget/delete-widget/${widget_id}`;
                    });
                    
                    document.getElementById("editSaveButton").addEventListener("click", function () {
                        var select = document.getElementById('widgetChoice');
                        var widget_id = select.options[select.selectedIndex].value;
                        var width = document.getElementById('width').value;
                        var height = document.getElementById('height').value;
                        var z_index = document.getElementById('z-index').value;
                        fetch(`/widget/update-widget/${widget_id}`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({ width: width, height: height, z_index: z_index })
                        }).then(function () {
                            location.reload();
                        });
                    });
                </script>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <img src="{{portal.banner.url}}" class="card-img-top" width="1400" height="350" style="filter: brightness(50%);">
                    <div class="card-body">
                        <img src="{{portal.avatar.url}}" class="rounded-circle" width="128" height="128" style="position: absolute;">
                        <h2 class="card-title text-right">{{portal.user.username}} Portal</h2>
                        {% if current_user != portal.user %}
                            {% if friends %}
                                <div class="container" style="margin: 0 120px;">
                                    <form method="post" action="{% url 'delete-friend' portal.user.pk %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-danger" type="submit">Delete Friend</button>
                                        <button class="btn btn-sm btn-danger" type="submit">Delete Friend</button>
                                    </form>
                                </div>
                            {% elif acceptSent %}
                                <div class="row" style="margin: 0 100px;">
                                    <div class="col-1">
                                        <form method="post" action="{% url 'accept' portal.user.pk %}">
                                            {% csrf_token %}
                                            <button class="btn btn-sm btn-success" type="submit"><i class="bi bi-check-lg"></i></button>
                                        </form>
                                    </div>
                                    <div class="col-1">
                                        <form method="post" action="{% url 'cancel' portal.user.pk %}">
                                            {% csrf_token %}
                                            <button class="btn btn-sm btn-secondary" type="submit"><i class="bi bi-x-lg"></i></button>
                                        </form>
                                    </div>
                                </div>
                            {% else %}
                                <div class="container" style="margin: 0 100px;">
                                    <form method="post" action="{% url 'send-request' portal.user.pk %}">
                                        {% csrf_token %}
                                        <button class="btn btn-info" type="submit">{% if requestSent %}Cancel Request{% else %}Add Friend{% endif %}</button>
                                    </form>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-12" style="margin: 60px 0 0 0;">
                <h5>About {{portal.user.username}}:</h5>
                {% if current_user == portal.user %}
                    <a href="{% url 'portal-create' %}">Edit Profile</a>
                {% endif %}
                <br>
                <p>Friends: {{portal.user.friend_list.friends.count}}</p>
                <p>Joined at: {{portal.joined_at}}</p>
                <p>{{portal.about}}</p>
            </div>
        </div>
        <script>
            let editMode = false;
            
            window.onload = () => {
                if ("{{current_user}}" == "{{portal.user}}") {
                    const widgets = document.querySelectorAll('.widget');
                    
                    document.getElementById('edit').addEventListener('click', editFunction);
                    
                    function editFunction() {
                        if (editMode) {
                            location.reload();
                        } else {
                            editMode = true;
                            document.getElementById('edit').innerText = 'Save';
                            widgets.forEach(widget => makeDraggable(widget));  
                        }
                    }
                }
            }
        
            function updatePosition(widgetId, x, y) {
                fetch(`/widget/update-widget-position/${widgetId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ x_position: x, y_position: y })
                });
            }
        
            function makeDraggable(widget) {
                let newX = 0, newY = 0, startX = 0, startY = 0, newTop = 0, newLeft = 0;
                
                const container = widget.parentElement;
                const containerRect = container.getBoundingClientRect();
                
                widget.addEventListener('mousedown', function (e) {
                    startX = e.clientX
                    startY = e.clientY
                    
                    document.addEventListener('mousemove', mouseMove)
                    document.addEventListener('mouseup', mouseUp)
                });
                
                function mouseMove(e) {
                    newX = startX - e.clientX
                    newY = startY - e.clientY
                    
                    startX = e.clientX
                    startY = e.clientY
                    
                    newTop = widget.offsetTop - newY;
                    newLeft = widget.offsetLeft - newX;
                    
                    const widgetRect = widget.getBoundingClientRect();
                    
                    if (newLeft < 0) {
                        newLeft = 0;
                        console.log('LEFT');
                    } else if (newLeft + widgetRect.width > containerRect.width) {
                        newLeft = containerRect.width - widgetRect.width;
                        console.log('RIGHT');
                    }
                    
                    if (newTop < 0) {
                        newTop = 0;
                        console.log("TOP");
                    } else if (newTop + widgetRect.height > 500) {
                        newTop = 500 - widgetRect.height;
                    }
                    
                    widget.style.top = newTop + 'px'
                    widget.style.left = newLeft + 'px'
                    
                }
                
                function mouseUp(e) {
                    let x = parseInt(widget.style.left);
                    let y = parseInt(widget.style.top);
                    updatePosition(widget.dataset.id, x, y);
                    document.removeEventListener('mousemove', mouseMove);
                }
                
            }
        </script>
        {% if current_user == portal.user %}
            <button id="edit" type="button" class="btn btn-secondary">Edit Portal</button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">Add Widget</button>
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editModal">Edit Widget</button>
        {% endif %}
        <div class="row">
            <div class="col">
                {% for widget in widgets %}
                    <div class="card widget text-dark" data-id="{{ widget.id }}" style="z-index: {{widget.z_index}}; left: {{widget.x_position}}px; top: {{widget.y_position}}px;">
                        {% if widget.widget_type == 'text' %}
                            {{ widget.content }}
                        {% elif widget.widget_type == 'image' %}
                            <img src="{{ widget.image.url }}" alt="Widget Image" width="{{widget.width}}" height="{{widget.height}}" style="pointer-events: none;">
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock content %}